(function(e){"use strict";function t(e){Object.defineProperty(this,"_bindings",{value:[],writable:!0}),Object.defineProperty(this,"_eventListeners",{value:{},writable:!0}),Object.defineProperty(this,"_heldEvents",{value:null,writable:!0}),Object.defineProperty(this,"_options",{value:e||{}})}function n(e,n){if(t.call(this,n),Object.defineProperty(this,"_values",{value:{},writable:!0}),e)for(var i in e)e.hasOwnProperty(i)&&this.set(i,e[i])}function i(e,t){Object.defineProperty(this,"_functions",{value:{},writable:!0}),n.call(this,e,t)}function r(e,n){e instanceof Array?n=n||{}:(n=e,e=[]);for(var i in r.prototype)Object.defineProperty(e,i,{value:r.prototype[i],writable:!1});t.call(e,n);for(var s=0,o=e.length;o>s;s++){var h=this.wrap(e[s]);n.bindChildren!==!1&&this._bindValue(s,h),e[s]=h}return e}t.prototype.on=t.prototype.bind=function(e,t,n){if(n=n||{},e.indexOf(" ")>-1){for(var i=e.split(" "),r=0,s=i.length;s>r;r++)this.on(i[r],t,{context:n.context});n.initialFire&&this.fire(i[0],{})}else if(this._eventListeners.hasOwnProperty(e)||(this._eventListeners[e]=[]),this._eventListeners[e].push(t),n.context&&(t.context=n.context),n.initialFire){var o={};if(e.indexOf(":")>-1){var h=e.substr(e.indexOf(":")+1);o.key=h,o.value=this[h]}this.fire(e,o)}},t.prototype.fire=function(e,t){var n,r,s=0;if(e.indexOf(" ")>-1){var o=e.split(" ");for(n=o.length;n>s;s++){var h={};for(var a in t)h[a]=t[a];this.fire(o[s],h)}}else if(t=t||{},t.name=e,this._heldEvents){for(n=this._heldEvents.length;n>s;s++)if(this._heldEvents[s].name===e)return;this._heldEvents.push(t)}else{if(this._eventListeners.hasOwnProperty(e)){var l=this._eventListeners[e].slice();for(n=l.length;n>s;s++)r=l[s],r.call(r.context||this,t)}"change"===e&&t.key&&this instanceof i&&this.fire("change:"+t.key,t)}},t.prototype.log=function(e){"undefined"!=typeof console&&console.log&&console.log("laces.js: "+e)},t.prototype.holdEvents=function(){this._heldEvents=[]},t.prototype.fireHeldEvents=function(){if(!this._heldEvents)return this.log("Need a call to holdEvents() before calling fireHeldEvents()"),void 0;var e=this._heldEvents;this._heldEvents=null;for(var t=0,n=e.length;n>t;t++){var i=e[t];this.fire(i.name,i)}},t.prototype.discardHeldEvents=function(){this._heldEvents=null},t.prototype.off=t.prototype.unbind=function(e,t){if("function"==typeof e){var n=!1;for(e in this._eventListeners)this._eventListeners.hasOwnProperty(e)&&this.off(e,t)&&(n=!0);return n}if(!this._eventListeners.hasOwnProperty(e))return!1;var i=this._eventListeners[e].indexOf(t);return i>-1?(this._eventListeners[e].splice(i,1),!0):!1},t.prototype.wrap=function(e){var t;if(e&&(e._gotLaces||e instanceof Date))t=e;else if(e instanceof Array){t=new r(this._options);for(var i=0,s=e.length;s>i;i++)t.set(i,e[i])}else t=e instanceof Function?e:e instanceof Object?new n(e,this._options):e;return t},t.prototype._gotLaces=!0,t.prototype._bindValue=function(e,t){if(t&&t._gotLaces){var n=this,i=!1,r=function(r){i||(i=!0,n.fire("change",{key:e,value:t,event:r}),i=!1)};t.on("change",r),this._bindings.push(r)}},t.prototype._unbindValue=function(e){if(e&&e._gotLaces)for(var t=0,n=this._bindings.length;n>t;t++)if(e.off("change",this._bindings[t])){this._bindings.splice(t,1);break}},n.prototype=new t,n.prototype.constructor=n,n.prototype.get=function(e){return this._values[e]},n.prototype.keys=function(){return Object.keys(this._values)},n.prototype.remove=function(e){if(this._values.hasOwnProperty(e)){var t=this._values[e];return this._unbindValue(t),delete this._values[e],delete this[e],this.fire("remove change",{key:e,oldValue:t}),!0}return!1},n.prototype.set=function(e,t,n){n=n||{};var i=this,r=function(){return this._values[e]},s=function(t){this._setValue(e,t)};n.type?"boolean"===n.type?s=function(t){i._setValue(e,!!t)}:"float"===n.type||"number"===n.type?s=function(t){i._setValue(e,parseFloat(t,10))}:"integer"===n.type?s=function(t){i._setValue(e,parseInt(t,10))}:"string"===n.type&&(s=function(t){i._setValue(e,""+t)}):n.setFilter&&(s=function(t){try{i._setValue(e,n.setFilter(t))}catch(r){i.log("Invalid value for property "+e+": "+t)}}),Object.defineProperty(this,e,{get:r,set:s,configurable:!0,enumerable:!0}),s.call(this,t)},n.prototype._setValue=function(e,t){t=this.wrap(t);var n={key:e,value:t},i=!1;if(this._values.hasOwnProperty(e)){var r=this._values[e];if(r===t)return;this._options.bindChildren!==!1&&this._unbindValue(r),n.oldValue=r}else i=!0;this._values[e]=t,this._options.bindChildren!==!1&&this._bindValue(e,t),i?this.fire("add change",n):this.fire("update change",n)},i.prototype=new n,i.prototype.constructor=i,i.prototype.set=function(e,t,i){function r(){p._reevaluate(e)}if(i=i||{},"function"==typeof t){var s=i.dependencies?i.dependencies.slice(0):[];this._functions[e]=t;for(var o,h=""+t,a=/this.(\w+)/g;null!==(o=a.exec(h));){var l=o[1];-1===s.indexOf(l)&&s.push(l)}for(var p=this,u=0,f=s.length;f>u;u++){var c=s[u];this.on("change:"+c,r)}t=t.call(this)}n.prototype.set.call(this,e,t,i)},i.prototype._reevaluate=function(e){var t=this._functions[e].call(this);this._setValue(e,t)},r.prototype=new t,r.prototype.constructor=r,r.prototype.get=function(e){return this[e]},r.prototype.pop=function(){var e=Array.prototype.pop.call(this);return this._options.bindChildren!==!1&&this._unbindValue(e),this.fire("remove change",{elements:[e],index:this.length}),e},r.prototype.push=function(){for(var e=[],t=this.length,n=0,i=arguments.length;i>n;n++){var r=this.wrap(arguments[n]);this._options.bindChildren!==!1&&this._bindValue(this.length,r),e.push(r)}Array.prototype.push.apply(this,e),this.fire("add change",{elements:e,index:t})},r.prototype.remove=function(e){if(this.length>e){var t=this[e];this._options.bindChildren!==!1&&this._unbindValue(t),Array.prototype.splice.call(this,e,1),this.fire("remove change",{elements:[t],index:e})}},r.prototype.reverse=function(){return Array.prototype.reverse.call(this),this.fire("change",{elements:[]}),this},r.prototype.set=function(e,t){var n=!0;this.length>e&&(this._options.bindChildren!==!1&&this._unbindValue(this[e]),n=!1),t=this.wrap(t),this[e]=t,this._options.bindChildren!==!1&&this._bindValue(e,t);var i={elements:[t],index:e};this.fire((n?"add":"update")+" change",i)},r.prototype.shift=function(){var e=Array.prototype.shift.call(this);return this._options.bindChildren!==!1&&this._unbindValue(e),this.fire("remove change",{elements:[e],index:0}),e},r.prototype.sort=function(e){return Array.prototype.sort.call(this,e),this.fire("change",{elements:[],index:0}),this},r.prototype.splice=function(e){for(var t=Array.prototype.splice.apply(this,arguments),n=[],i=2,r=arguments.length;r>i;i++)n.push(arguments[i]);if(t.length>0){if(this._options.bindChildren!==!1)for(i=0,r=t.length;r>i;i++)this._unbindValue(t[i]);this.fire("remove change",{elements:t,index:e})}if(n.length>0){if(this._options.bindChildren!==!1)for(i=0,r=n.length;r>i;i++)this._bindValue(e+i,n[j]);this.fire("add change",{elements:n,index:e})}return t},r.prototype.unshift=function(){for(var e=[],t=0,n=arguments.length;n>t;t++){var i=this.wrap(arguments[t]);this._options.bindChildren!==!1&&this._bindValue(t,i),e.push(i)}return Array.prototype.unshift.apply(this,e),this.fire("add change",{elements:e,index:0}),this.length};var s={Model:i,Map:n,Array:r};if("object"==typeof exports&&exports&&"object"==typeof module&&module&&module.exports===exports)module.exports=s;else if("function"==typeof define&&define.amd)define(s);else for(var o in s)s.hasOwnProperty(o)&&(e["Laces"+o]=s[o])})(this);