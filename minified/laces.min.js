(function(e){"use strict";function t(e){Object.defineProperty(this,"_bindings",{value:[],writable:!0}),Object.defineProperty(this,"_eventListeners",{value:{},writable:!0}),Object.defineProperty(this,"_heldEvents",{value:null,writable:!0}),Object.defineProperty(this,"_options",{value:e||{}})}function i(e,i){if(t.call(this,i),Object.defineProperty(this,"_values",{value:{},writable:!0}),e)for(var n in e)e.hasOwnProperty(n)&&this.set(n,e[n])}function n(e,t){Object.defineProperty(this,"_functions",{value:{},writable:!0}),i.call(this,e,t)}function r(e,i){e instanceof Array?i=i||{}:(i=e,e=[]);for(var n in r.prototype)Object.defineProperty(e,n,{value:r.prototype[n],writable:!1});t.call(e,i);for(var s=0,o=e.length;o>s;s++){var h=this.wrap(e[s]);i.bindChildren!==!1&&this._bindValue(s,h),e[s]=h}return e}t.prototype.on=t.prototype.bind=function(e,t,i){if(i=i||{},e.indexOf(" ")>-1){for(var n=e.split(" "),r=0,s=n.length;s>r;r++)this.bind(n[r],t);i.initialFire&&this.fire(n[0],{})}else if(this._eventListeners.hasOwnProperty(e)||(this._eventListeners[e]=[]),this._eventListeners[e].push(t),i.initialFire){var o={};if(e.indexOf(":")>-1){var h=e.substr(e.indexOf(":")+1);o.key=h,o.value=this[h]}this.fire(e,o)}},t.prototype.fire=function(e,t){var i,r=0;if(e.indexOf(" ")>-1){var s=e.split(" ");for(i=s.length;i>r;r++){var o={};for(var h in t)o[h]=t[h];this.fire(s[r],o)}}else if(t=t||{},t.name=e,this._heldEvents instanceof Array){for(i=this._heldEvents.length;i>r;r++)if(this._heldEvents[r].name===e)return;this._heldEvents.push(t)}else{var a;if(this._eventListeners.hasOwnProperty(e))for(a=this._eventListeners[e],i=a.length;i>r;r++)a[r].call(this,t);if("change"===e&&t.key&&this instanceof n&&(e="change:"+t.key,t.name=e,this._eventListeners.hasOwnProperty(e)))for(a=this._eventListeners[e],r=0,i=a.length;i>r;r++)a[r].call(this,t)}},t.prototype.log=function(e){"undefined"!=typeof console&&console.log&&console.log("laces.js: "+e)},t.prototype.holdEvents=function(){this._heldEvents=[]},t.prototype.fireHeldEvents=function(){if(null===this._heldEvents)return this.log("Need a call to holdEvents() before calling fireHeldEvents()"),void 0;var e=this._heldEvents;this._heldEvents=null;for(var t=0,i=e.length;i>t;t++){var n=e[t];this.fire(n.name,n)}},t.prototype.discardHeldEvents=function(){this._heldEvents=null},t.prototype.off=t.prototype.unbind=function(e,t){if("function"==typeof e){var i=!1;for(e in this._eventListeners)this._eventListeners.hasOwnProperty(e)&&this.unbind(e,t)&&(i=!0);return i}if(!this._eventListeners.hasOwnProperty(e))return!1;var n=this._eventListeners[e].indexOf(t);return n>-1?(this._eventListeners[e].splice(n,1),!0):!1},t.prototype.wrap=function(e){var t;if(e&&e._gotLaces)t=e;else if(e instanceof Array){t=new r(this._options);for(var n=0,s=e.length;s>n;n++)t.set(n,e[n])}else t=e instanceof Function?e:e instanceof Object?new i(e,this._options):e;return t},t.prototype._gotLaces=!0,t.prototype._bindValue=function(e,t){if(t&&t._gotLaces){var i=this,n=!1,r=function(){n||(n=!0,i.fire("change",{key:e,value:t}),n=!1)};t.bind("change",r),this._bindings.push(r)}},t.prototype._unbindValue=function(e){if(e&&e._gotLaces)for(var t=0,i=this._bindings.length;i>t;t++)if(e.unbind("change",this._bindings[t])){this._bindings.splice(t,1);break}},i.prototype=new t,i.prototype.constructor=i,i.prototype.get=function(e){return this._values[e]},i.prototype.remove=function(e){if(this._values.hasOwnProperty(e)){var t=this._values[e];return this._unbindValue(t),delete this._values[e],delete this[e],this.fire("remove change",{key:e,oldValue:t}),!0}return!1},i.prototype.set=function(e,t,i){i=i||{};var n=this,r=function(){return this._values[e]},s=function(t){this._setValue(e,t)};i.type?"boolean"===i.type?s=function(t){n._setValue(e,!!t)}:"float"===i.type||"number"===i.type?s=function(t){n._setValue(e,parseFloat(t,10))}:"integer"===i.type?s=function(t){n._setValue(e,parseInt(t,10))}:"string"===i.type&&(s=function(t){n._setValue(e,""+t)}):i.setFilter&&(s=function(t){try{n._setValue(e,i.setFilter(t))}catch(r){n.log("Invalid value for property "+e+": "+t)}}),Object.defineProperty(this,e,{get:r,set:s,configurable:!0,enumerable:!0}),s.call(this,t)},i.prototype._setValue=function(e,t){t=this.wrap(t);var i={key:e,value:t},n=!1;if(this._values.hasOwnProperty(e)){var r=this._values[e];if(r===t)return;this._options.bindChildren!==!1&&this._unbindValue(r),i.oldValue=r}else n=!0;this._values[e]=t,this._options.bindChildren!==!1&&this._bindValue(e,t),n?this.fire("add change",i):this.fire("update change",i)},n.prototype=new i,n.prototype.constructor=n,n.prototype.set=function(e,t,n){function r(){p._reevaluate(e)}if(n=n||{},"function"==typeof t){var s=n.dependencies||[];this._functions[e]=t;for(var o,h=""+t,a=/this.(\w+)/g;null!==(o=a.exec(h));){var l=o[1];-1===s.indexOf(l)&&s.push(l)}for(var p=this,u=0,f=s.length;f>u;u++){var c=s[u];this.bind("change:"+c,r)}t=t.call(this)}i.prototype.set.call(this,e,t,n)},n.prototype._reevaluate=function(e){var t=this._functions[e].call(this);this._setValue(e,t)},r.prototype=new t,r.prototype.constructor=r,r.prototype.get=function(e){return this[e]},r.prototype.pop=function(){var e=Array.prototype.pop.call(this);return this._options.bindChildren!==!1&&this._unbindValue(e),this.fire("remove change",{elements:[e],index:this.length}),e},r.prototype.push=function(){for(var e=[],t=this.length,i=0,n=arguments.length;n>i;i++){var r=this.wrap(arguments[i]);this._options.bindChildren!==!1&&this._bindValue(this.length,r),e.push(r)}Array.prototype.push.apply(this,e),this.fire("add change",{elements:e,index:t})},r.prototype.remove=function(e){if(this.length>e){var t=this[e];this._options.bindChildren!==!1&&this._unbindValue(t),Array.prototype.splice.call(this,e,1),this.fire("remove change",{elements:[t],index:e})}},r.prototype.reverse=function(){Array.prototype.reverse.call(this),this.fire("change",{elements:[]})},r.prototype.set=function(e,t){var i=!0;this.length>e&&(this._options.bindChildren!==!1&&this._unbindValue(this[e]),i=!1),t=this.wrap(t),this[e]=t,this._options.bindChildren!==!1&&this._bindValue(e,t);var n={elements:[t],index:e};this.fire((i?"add":"update")+" change",n)},r.prototype.shift=function(){var e=Array.prototype.shift.call(this);return this._options.bindChildren!==!1&&this._unbindValue(e),this.fire("remove change",{elements:[e],index:0}),e},r.prototype.sort=function(){return Array.prototype.sort.call(this),this.fire("change",{elements:[],index:0}),this},r.prototype.splice=function(e){for(var t=Array.prototype.splice.apply(this,arguments),i=[],n=2,r=arguments.length;r>n;n++)i.push(arguments[n]);if(t.length>0){if(this._options.bindChildren!==!1)for(n=0,r=t.length;r>n;n++)this._unbindValue(t[n]);this.fire("remove change",{elements:t,index:e})}if(i.length>0){if(this._options.bindChildren!==!1)for(n=0,r=i.length;r>n;n++)this._bindValue(e+n,i[j]);this.fire("add change",{elements:i,index:e})}return t},r.prototype.unshift=function(){for(var e=[],t=0,i=arguments.length;i>t;t++){var n=this.wrap(arguments[t]);this._options.bindChildren!==!1&&this._bindValue(t,n),e.push(n)}return Array.prototype.unshift.apply(this,arguments),this.fire("add change",{elements:arguments,index:0}),this.length};var s={Model:n,Map:i,Array:r};if("object"==typeof exports&&exports&&"object"==typeof module&&module&&module.exports===exports)module.exports=s;else if("function"==typeof define&&define.amd)define(s);else for(var o in s)s.hasOwnProperty(o)&&(e["Laces"+o]=s[o])})(this);